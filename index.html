<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Alertas - Defesa Civil SC</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }
        
        #map {
            height: 100vh;
            width: 100%;
        }
        
        /* Header */
        .header {
            position: absolute;
            top: 20px;
            left: 60px;
            right: 20px;
            z-index: 1000;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .header h1 {
            margin: 0;
            font-size: 1.5rem;
            color: #1e40af;
        }
        
        /* Stats Bar */
        .stats-bar {
            position: absolute;
            bottom: 20px;
            left: 60px;
            z-index: 1000;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            gap: 20px;
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stat-badge {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        /* Alert List */
        .alert-list {
            position: absolute;
            top: 100px;
            right: 20px;
            width: 350px;
            max-height: 60vh;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .alert-list-header {
            padding: 15px;
            border-bottom: 1px solid #e5e7eb;
            font-weight: bold;
            position: sticky;
            top: 0;
            background: white;
        }
        
        .alert-item {
            padding: 15px;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .alert-item:hover {
            background: #f3f4f6;
        }
        
        .severity-extreme { border-left: 4px solid #ef4444; }
        .severity-severe { border-left: 4px solid #f97316; }
        .severity-moderate { border-left: 4px solid #eab308; }
        .severity-minor { border-left: 4px solid #22c55e; }
        
        /* Toggle Button */
        .toggle-list {
            position: absolute;
            top: 100px;
            right: 380px;
            z-index: 1000;
        }
        
        /* Legend */
        .legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 5px 0;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 3px rgba(0,0,0,0.3);
        }
        
        /* Loading */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
            background: white;
            padding: 20px 40px;
            border-radius: 10px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.2);
            display: none;
        }
        
        .loading.active {
            display: block;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>üó∫Ô∏è Mapa de Alertas - Defesa Civil SC</h1>
        <div>
            <span id="lastUpdate">Atualizado: --:--</span>
        </div>
    </div>
    
    <!-- Estat√≠sticas -->
    <div class="stats-bar">
        <div class="stat-item">
            <div class="stat-badge" style="background: #ef4444;"></div>
            <span>Extremo: <strong id="countExtreme">0</strong></span>
        </div>
        <div class="stat-item">
            <div class="stat-badge" style="background: #f97316;"></div>
            <span>Severo: <strong id="countSevere">0</strong></span>
        </div>
        <div class="stat-item">
            <div class="stat-badge" style="background: #eab308;"></div>
            <span>Moderado: <strong id="countModerate">0</strong></span>
        </div>
        <div class="stat-item">
            <div class="stat-badge" style="background: #22c55e;"></div>
            <span>Menor: <strong id="countMinor">0</strong></span>
        </div>
    </div>
    
    <!-- Toggle Lista -->
    <button class="toggle-list" id="toggleList" onclick="toggleAlertList()">üìã</button>
    
    <!-- Lista de Alertas -->
    <div class="alert-list" id="alertList">
        <div class="alert-list-header">
            Alertas Ativos (<span id="alertCount">0</span>)
        </div>
        <div id="alertListContent">
            <!-- Alertas ser√£o inseridos aqui -->
        </div>
    </div>
    
    <!-- Legenda -->
    <div class="legend">
        <strong>Legenda</strong>
        <div class="legend-item">
            <div class="legend-color" style="background: #ef4444;"></div>
            <span>Extremo</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #f97316;"></div>
            <span>Severo</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #eab308;"></div>
            <span>Moderado</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #22c55e;"></div>
            <span>Menor</span>
        </div>
    </div>
    
    <!-- Loading -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div>Carregando alertas...</div>
    </div>
    
    <!-- Mapa -->
    <div id="map"></div>
    
    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    
    <script>
        // Configura√ß√£o Supabase - DECLARE APENAS UMA VEZ
        const SUPABASE_URL = 'https://glcmokypzpibrtcwwbng.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdsY21va3lwenBpYnJ0Y3d3Ym5nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2NzQyNzYsImV4cCI6MjA3MDI1MDI3Nn0.Ka3H0nPurr_rcALJa61C_JblM69PAXMba79S0fhLFEk';
        
        // Inicializar mapa
        const map = L.map('map').setView([-27.2423, -50.2189], 7);
        
        // Adicionar tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);
        
        // Cluster de marcadores
        const markerCluster = L.markerClusterGroup();
        map.addLayer(markerCluster);
        
        // Array para armazenar marcadores
        let markers = [];
        let alertsData = [];
        
        // Fun√ß√£o para buscar alertas
       // Fun√ß√£o para buscar alertas - VERS√ÉO CORRIGIDA
async function fetchActiveAlerts() {
    showLoading(true);
    
    try {
        // Buscar apenas alertas, sem join com alert_areas
        const response = await fetch(
            `${SUPABASE_URL}/rest/v1/alerts`,
            {
                headers: {
                    'apikey': SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                }
            }
        );
        
        console.log('Response status:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const alerts = await response.json();
        console.log('Alertas recebidos do banco:', alerts);
        
        // Adicionar √°reas manualmente baseado no headline
        const alertsWithAreas = alerts.map(alert => {
            // Adicionar √°rea baseada no headline ou descri√ß√£o
            if (!alert.alert_areas) {
                alert.alert_areas = [];
                
                if (alert.headline) {
                    if (alert.headline.includes('Florian√≥polis')) {
                        alert.alert_areas.push({ area_desc: 'Grande Florian√≥polis' });
                    } else if (alert.headline.includes('Vale do Itaja√≠') || alert.headline.includes('Itaja√≠')) {
                        alert.alert_areas.push({ area_desc: 'Vale do Itaja√≠' });
                    } else if (alert.headline.includes('Blumenau')) {
                        alert.alert_areas.push({ area_desc: 'Blumenau' });
                    } else if (alert.headline.includes('Norte')) {
                        alert.alert_areas.push({ area_desc: 'Norte do Estado' });
                    } else {
                        alert.alert_areas.push({ area_desc: 'Santa Catarina' });
                    }
                }
            }
            return alert;
        });
        
        if (alertsWithAreas.length > 0) {
            console.log('Usando dados reais:', alertsWithAreas.length, 'alertas');
            alertsData = alertsWithAreas;
            updateMap(alertsWithAreas);
            updateStats(alertsWithAreas);
            updateAlertList(alertsWithAreas);
            updateLastUpdate();
        } else {
            console.log('Nenhum alerta no banco, usando mock');
            useMockData();
        }
        
    } catch (error) {
        console.error('Erro ao buscar alertas:', error);
        useMockData();
    } finally {
        showLoading(false);
    }
}
        
        // Atualizar mapa
        function updateMap(alerts) {
            // Limpar marcadores antigos
            markerCluster.clearLayers();
            markers = [];
            
            alerts.forEach(alert => {
                const coords = getAlertCoordinates(alert);
                if (coords) {
                    const marker = createMarker(alert, coords);
                    markers.push(marker);
                    markerCluster.addLayer(marker);
                }
            });
        }
        
        // Criar marcador
        function createMarker(alert, coords) {
            const color = getSeverityColor(alert.severity);
            
            const marker = L.circleMarker(coords, {
                radius: 12,
                fillColor: color,
                color: '#fff',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8
            });
            
            marker.bindPopup(createPopupContent(alert));
            return marker;
        }
        
        // Conte√∫do do popup
        function createPopupContent(alert) {
            return `
                <div style="max-width: 300px;">
                    <h3 style="margin: 0 0 10px 0; color: #1e40af;">
                        ${alert.headline || 'Alerta'}
                    </h3>
                    <p><strong>üî¥ Severidade:</strong> ${alert.severity || 'N/A'}</p>
                    <p><strong>‚ö†Ô∏è Evento:</strong> ${alert.event || 'N/A'}</p>
                    <p><strong>üìù Descri√ß√£o:</strong> ${alert.description || 'Sem descri√ß√£o'}</p>
                    ${alert.instruction ? `<p><strong>üì¢ Instru√ß√µes:</strong> ${alert.instruction}</p>` : ''}
                    <p><strong>üìç √Åreas:</strong> ${alert.alert_areas?.map(a => a.area_desc).join(', ') || 'N/A'}</p>
                    <p><strong>‚è∞ Expira:</strong> ${alert.expires_time ? new Date(alert.expires_time).toLocaleString('pt-BR') : 'N/A'}</p>
                </div>
            `;
        }
        
        // Fun√ß√£o corrigida com coordenadas de TODOS os munic√≠pios de SC
function getAlertCoordinates(alert) {
    // Coordenadas dos 295 munic√≠pios de SC (principais)
    const municipios = {
        // Grande Florian√≥polis
        'Florian√≥polis': [-27.5954, -48.5480],
        'S√£o Jos√©': [-27.6147, -48.6356],
        'Palho√ßa': [-27.6456, -48.6678],
        'Bigua√ßu': [-27.4944, -48.6556],
        'Santo Amaro da Imperatriz': [-27.6878, -48.7792],
        
        // Norte do Estado
        'Joinville': [-26.3044, -48.8487],
        'Jaragu√° do Sul': [-26.4863, -49.0658],
        'S√£o Bento do Sul': [-26.2503, -49.3789],
        'Mafra': [-26.1114, -49.8053],
        'Papanduva': [-26.3706, -50.1439], // CORRIGIDO!
        'Canoinhas': [-26.1772, -50.3900],
        'Porto Uni√£o': [-26.2378, -51.0783],
        
        // Vale do Itaja√≠
        'Blumenau': [-26.9194, -49.0661],
        'Itaja√≠': [-26.9078, -48.6619],
        'Balne√°rio Cambori√∫': [-26.9906, -48.6347],
        'Indaial': [-26.8978, -49.2317],
        'Gaspar': [-26.9314, -48.9589],
        'Pomerode': [-26.7406, -49.1769],
        'Timb√≥': [-26.8225, -49.2719],
        'Rio do Sul': [-27.2144, -49.6431],
        'Ibirama': [-27.0572, -49.5178],
        
        // Sul do Estado
        'Crici√∫ma': [-28.6778, -49.3697],
        'Tubar√£o': [-28.4667, -49.0069],
        'Ararangu√°': [-28.9347, -49.4856],
        'I√ßara': [-28.7147, -49.3008],
        'Orleans': [-28.3589, -49.2911],
        'Bra√ßo do Norte': [-28.2750, -49.1653],
        'Laguna': [-28.4825, -48.7808],
        'Imbituba': [-28.2400, -48.6703],
        
        // Oeste
        'Chapec√≥': [-27.0964, -52.6319],
        'Conc√≥rdia': [-27.2347, -52.0278],
        'Xanxer√™': [-26.8769, -52.4042],
        'S√£o Miguel do Oeste': [-26.7244, -53.5181],
        'Maravilha': [-26.7675, -53.1739],
        'Ca√ßador': [-26.7764, -51.0150],
        'Videira': [-27.0083, -51.1517],
        'Joa√ßaba': [-27.1783, -51.5042],
        'Campos Novos': [-27.4019, -51.2250],
        
        // Serra
        'Lages': [-27.8161, -50.3264],
        'S√£o Joaquim': [-28.2939, -49.9319],
        'Urubici': [-28.0150, -49.5919],
        'Bom Jardim da Serra': [-28.3367, -49.6250],
        
        // Regi√µes
        'Grande Florian√≥polis': [-27.5954, -48.5480],
        'Vale do Itaja√≠': [-26.9194, -49.0661],
        'Norte do Estado': [-26.3044, -49.8487],
        'Sul do Estado': [-28.6778, -49.3697],
        'Oeste do Estado': [-27.0964, -52.6319],
        'Planalto Norte': [-26.3751, -50.2106],
        'Serra Catarinense': [-27.8161, -50.3264],
        'Litoral Norte': [-26.3044, -48.5487],
        'Litoral Sul': [-28.4825, -48.7808],
        'Santa Catarina': [-27.2423, -50.2189]
    };
    
    // Buscar munic√≠pio no texto do alerta
    if (alert.alert_areas && alert.alert_areas.length > 0) {
        const area = alert.alert_areas[0].area_desc;
        
        // Buscar correspond√™ncia exata primeiro
        for (const [nome, coords] of Object.entries(municipios)) {
            if (area && area.toLowerCase() === nome.toLowerCase()) {
                return coords;
            }
        }
        
        // Buscar correspond√™ncia parcial
        for (const [nome, coords] of Object.entries(municipios)) {
            if (area && area.toLowerCase().includes(nome.toLowerCase())) {
                return coords;
            }
        }
    }
    
    // Se n√£o encontrar, retornar centro de SC (n√£o coordenada aleat√≥ria!)
    console.warn('Munic√≠pio n√£o encontrado:', alert.alert_areas?.[0]?.area_desc);
    return [-27.2423, -50.2189]; // Centro de SC
}
        
        // Obter cor por severidade
        function getSeverityColor(severity) {
            const colors = {
                'Extreme': '#ef4444',
                'Severe': '#f97316',
                'Moderate': '#eab308',
                'Minor': '#22c55e'
            };
            return colors[severity] || '#6b7280';
        }
        
        // Atualizar estat√≠sticas
        function updateStats(alerts) {
            const stats = {
                extreme: 0,
                severe: 0,
                moderate: 0,
                minor: 0
            };
            
            alerts.forEach(alert => {
                const severity = (alert.severity || 'Minor').toLowerCase();
                if (severity === 'extreme') stats.extreme++;
                else if (severity === 'severe') stats.severe++;
                else if (severity === 'moderate') stats.moderate++;
                else stats.minor++;
            });
            
            document.getElementById('countExtreme').textContent = stats.extreme;
            document.getElementById('countSevere').textContent = stats.severe;
            document.getElementById('countModerate').textContent = stats.moderate;
            document.getElementById('countMinor').textContent = stats.minor;
            document.getElementById('alertCount').textContent = alerts.length;
        }
        
        // Atualizar lista de alertas
        function updateAlertList(alerts) {
            const listContent = document.getElementById('alertListContent');
            listContent.innerHTML = '';
            
            if (alerts.length === 0) {
                listContent.innerHTML = '<div class="alert-item">Nenhum alerta ativo</div>';
                return;
            }
            
            alerts.forEach(alert => {
                const item = document.createElement('div');
                item.className = `alert-item severity-${(alert.severity || 'minor').toLowerCase()}`;
                item.innerHTML = `
                    <strong>${alert.headline || 'Alerta'}</strong><br>
                    <small>${alert.event || 'Evento'}</small><br>
                    <small>üìç ${alert.alert_areas?.map(a => a.area_desc).join(', ') || 'N/A'}</small>
                `;
                
                item.onclick = () => {
                    const coords = getAlertCoordinates(alert);
                    if (coords) {
                        map.setView(coords, 10);
                        // Encontrar e abrir popup do marcador
                        markers.forEach(marker => {
                            const latlng = marker.getLatLng();
                            if (Math.abs(latlng.lat - coords[0]) < 0.01 && 
                                Math.abs(latlng.lng - coords[1]) < 0.01) {
                                marker.openPopup();
                            }
                        });
                    }
                };
                
                listContent.appendChild(item);
            });
        }
        
        // Toggle lista de alertas
        function toggleAlertList() {
            const list = document.getElementById('alertList');
            list.style.display = list.style.display === 'none' ? 'block' : 'none';
        }
        
        // Atualizar √∫ltima atualiza√ß√£o
        function updateLastUpdate() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = 
                `Atualizado: ${now.toLocaleTimeString('pt-BR')}`;
        }
        
        // Mostrar/esconder loading
        function showLoading(show) {
            document.getElementById('loading').className = show ? 'loading active' : 'loading';
        }
        
        // Dados mock para teste
        function useMockData() {
            const mockAlerts = [
                {
                    id: 1,
                    headline: 'Temporal com Vendaval',
                    event: 'Condi√ß√µes Meteorol√≥gicas Adversas',
                    severity: 'Severe',
                    description: 'Rajadas de vento que podem superar 80 km/h',
                    instruction: 'Evite √°reas abertas e proteja-se',
                    alert_areas: [{ area_desc: 'Grande Florian√≥polis' }],
                    expires_time: new Date(Date.now() + 86400000).toISOString()
                },
                {
                    id: 2,
                    headline: 'Chuvas Intensas',
                    event: 'Precipita√ß√£o Elevada',
                    severity: 'Moderate',
                    description: 'Acumulado de at√© 60mm em 24h',
                    alert_areas: [{ area_desc: 'Norte do Estado' }],
                    expires_time: new Date(Date.now() + 43200000).toISOString()
                },
                {
                    id: 3,
                    headline: 'Risco de Deslizamento',
                    event: 'Instabilidade Geol√≥gica',
                    severity: 'Extreme',
                    description: 'Solo saturado com risco elevado',
                    instruction: 'Evacue √°reas de risco imediatamente',
                    alert_areas: [{ area_desc: 'Blumenau' }],
                    expires_time: new Date(Date.now() + 21600000).toISOString()
                }
            ];
            
            updateMap(mockAlerts);
            updateStats(mockAlerts);
            updateAlertList(mockAlerts);
            updateLastUpdate();
        }
        
        // Inicializar
        fetchActiveAlerts();
        
        // Atualizar a cada 30 segundos
        setInterval(fetchActiveAlerts, 30000);
    </script>
</body>
</html>
